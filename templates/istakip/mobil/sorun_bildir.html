{% extends 'istakip/mobil/layout_mobil.html' %}

{% block title %}Sorun Bildir - Saha Personeli{% endblock %}

{% block content %}
<!-- Ana Form -->
<form method="post" enctype="multipart/form-data" id="main-form" class="space-y-4">
    {% csrf_token %}
    
    <!-- Gizli alanlar -->
    <input type="hidden" name="park_uuid" id="park-uuid">
    <input type="hidden" name="lat" id="lat">
    <input type="hidden" name="lng" id="lng">

<!-- Harita Bölümü - Tam Genişlik -->
<div class="bg-white shadow-soft rounded-2xl mb-4 overflow-hidden">
    <div class="p-3">
        <div class="flex items-center justify-between">
            <h2 class="text-base font-bold text-gray-900 flex items-center">
                <i class="fas fa-map-marker-alt text-park-green-600 mr-1.5"></i>
                Konum Tespiti
            </h2>
            <div id="location-status" class="hidden flex items-center">
                <div class="w-2 h-2 bg-park-green-500 rounded-full animate-pulse-green mr-1"></div>
                <span class="text-xs text-gray-500">Konum Alınıyor</span>
            </div>
        </div>
    </div>
    
    <!-- Harita - Tam Genişlik -->
    <div id="map" class="map-container bg-gray-100"></div>
    
    <div class="p-3">
        <!-- Konum Butonları -->
        <div class="flex space-x-2">
            <button type="button" id="find-location-btn" class="flex-1 bg-park-green-600 hover:bg-park-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm mobile-button">
                <i class="fas fa-crosshairs mr-1"></i>
                Konumumu Bul
            </button>
            <button type="button" id="refresh-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-3 rounded-lg transition-colors text-sm mobile-button">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        
        <!-- Konum Bilgisi -->
        <div id="location-info" class="mt-2 p-2 bg-gray-50 rounded-lg hidden">
            <div class="text-xs text-gray-600">Konum:</div>
            <div id="coordinates" class="text-xs text-gray-500"></div>
            <div id="distance" class="text-xs text-gray-500"></div>
        </div>
    </div>
</div>

<div class="space-y-4 p-3">    <!-- Durum Seçimi -->
    <div id="status-selection" class="bg-white rounded-2xl shadow-soft p-4 hidden">
        <h3 class="text-base font-bold text-gray-900 mb-4 text-center">Parkın Durumu Nasıl?</h3>
        <div class="grid grid-cols-1 gap-4">
            <!-- Sorun Yok Butonu -->
            <button type="button" id="no-problem-btn" class="group relative overflow-hidden bg-gradient-to-br from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border-2 border-emerald-200 hover:border-emerald-300 text-emerald-800 font-semibold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-[1.02] hover:shadow-lg mobile-button">
                <div class="flex items-center justify-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-green-600 rounded-full flex items-center justify-center shadow-lg group-hover:shadow-xl transition-shadow duration-300">
                        <i class="fas fa-check-circle text-white text-xl"></i>
                    </div>
                    <div class="text-left">
                        <div class="text-lg font-bold text-emerald-800">Sorun Yok</div>
                        <div class="text-xs text-emerald-600">Park durumu normal</div>
                    </div>
                </div>
                <!-- Subtle shine effect -->
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent transform -skew-x-12 translate-x-[-200%] group-hover:translate-x-[200%] transition-transform duration-700"></div>
            </button>
            
            <!-- Sorun Var Butonu -->
            <button type="button" id="problem-btn" class="group relative overflow-hidden bg-gradient-to-br from-red-50 to-orange-50 hover:from-red-100 hover:to-orange-100 border-2 border-red-200 hover:border-red-300 text-red-800 font-semibold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-[1.02] hover:shadow-lg mobile-button">
                <div class="flex items-center justify-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-orange-600 rounded-full flex items-center justify-center shadow-lg group-hover:shadow-xl transition-shadow duration-300">
                        <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                    </div>
                    <div class="text-left">
                        <div class="text-lg font-bold text-red-800">Sorun Var</div>
                        <div class="text-xs text-red-600">Müdahale gerekiyor</div>
                    </div>
                </div>
                <!-- Subtle shine effect -->
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent transform -skew-x-12 translate-x-[-200%] group-hover:translate-x-[200%] transition-transform duration-700"></div>
            </button>
        </div>
        
        <!-- Alt bilgi -->
        <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex items-center gap-2 text-blue-700">
                <i class="fas fa-info-circle text-sm"></i>
                <span class="text-xs font-medium">Durumu seçtikten sonra detayları girebilirsiniz</span>
            </div>
        </div>
    </div>
    
    <!-- Sorun Detay Formu -->
    <div id="problem-form" class="bg-white rounded-2xl shadow-soft p-4 hidden">
        <h3 class="text-base font-bold text-red-700 mb-3 flex items-center">
            <i class="fas fa-exclamation-triangle mr-1.5"></i>
            Sorun Detayları
        </h3>
        
        <div class="space-y-4">
            <!-- Sorun Türü -->
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Sorun Türü</label>
                <select id="problem-type" name="durum" class="w-full p-2 border border-gray-300 rounded-lg text-sm mobile-input focus:ring-1 focus:ring-red-500 focus:border-red-500">
                    <option value="sorun_var">Sorun Var</option>
                    <option value="acil">Acil Müdahale Gerekli</option>
                </select>
            </div>
            
            <!-- Açıklama -->
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Açıklama *</label>
                <textarea id="problem-description" name="aciklama" rows="3" class="w-full p-2 border border-gray-300 rounded-lg text-sm mobile-input resize-none focus:ring-1 focus:ring-red-500 focus:border-red-500" placeholder="Sorunun detaylarını yazın..." required></textarea>
            </div>              <!-- Resim Yükleme -->
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-images text-orange-600 mr-1.5"></i>
                    Resimler (Maksimum 3 adet)
                </label>
                
                <!-- Resim Upload Grid -->
                <div class="grid grid-cols-1 gap-3">
                    <!-- Resim 1 -->
                    <div class="image-upload-item bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 transition-all hover:border-park-green-400" id="upload-card-1">
                        <div class="p-3">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="file-input-wrapper">
                                    <label for="image-1" class="file-label cursor-pointer bg-gradient-to-r from-park-green-600 to-park-green-700 hover:from-park-green-700 hover:to-park-green-800 text-white text-xs py-2 px-4 rounded-xl transition-all shadow-soft inline-flex items-center">
                                        <i class="fas fa-camera mr-2"></i>
                                        <span class="label-text">1. Resim Seç</span>
                                    </label>
                                    <input type="file" id="image-1" name="resim_1" accept="image/jpeg,image/png,image/jpg" class="hidden" onchange="handleImageUpload(1)">
                                </div>
                                <span class="text-xs text-gray-500 flex items-center">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Max 5MB
                                </span>
                            </div>
                            <input type="text" id="image-desc-1" name="resim_aciklama_1" placeholder="Resim açıklaması (opsiyonel)" class="w-full p-2 border border-gray-300 rounded-lg text-xs focus:border-park-green-500 focus:ring-1 focus:ring-park-green-500">
                            <div class="preview-container mt-3" id="preview-1"></div>
                        </div>
                    </div>
                    
                    <!-- Resim 2 -->
                    <div class="image-upload-item bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 transition-all hover:border-park-green-400 hidden" id="upload-card-2">
                        <div class="p-3">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="file-input-wrapper">
                                    <label for="image-2" class="file-label cursor-pointer bg-gradient-to-r from-park-green-600 to-park-green-700 hover:from-park-green-700 hover:to-park-green-800 text-white text-xs py-2 px-4 rounded-xl transition-all shadow-soft inline-flex items-center">
                                        <i class="fas fa-camera mr-2"></i>
                                        <span class="label-text">2. Resim Seç</span>
                                    </label>
                                    <input type="file" id="image-2" name="resim_2" accept="image/jpeg,image/png,image/jpg" class="hidden" onchange="handleImageUpload(2)">
                                </div>
                                <span class="text-xs text-gray-500 flex items-center">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Max 5MB
                                </span>
                            </div>
                            <input type="text" id="image-desc-2" name="resim_aciklama_2" placeholder="Resim açıklaması (opsiyonel)" class="w-full p-2 border border-gray-300 rounded-lg text-xs focus:border-park-green-500 focus:ring-1 focus:ring-park-green-500">
                            <div class="preview-container mt-3" id="preview-2"></div>
                        </div>
                    </div>
                    
                    <!-- Resim 3 -->
                    <div class="image-upload-item bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 transition-all hover:border-park-green-400 hidden" id="upload-card-3">
                        <div class="p-3">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="file-input-wrapper">
                                    <label for="image-3" class="file-label cursor-pointer bg-gradient-to-r from-park-green-600 to-park-green-700 hover:from-park-green-700 hover:to-park-green-800 text-white text-xs py-2 px-4 rounded-xl transition-all shadow-soft inline-flex items-center">
                                        <i class="fas fa-camera mr-2"></i>
                                        <span class="label-text">3. Resim Seç</span>
                                    </label>
                                    <input type="file" id="image-3" name="resim_3" accept="image/jpeg,image/png,image/jpg" class="hidden" onchange="handleImageUpload(3)">
                                </div>
                                <span class="text-xs text-gray-500 flex items-center">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Max 5MB
                                </span>
                            </div>
                            <input type="text" id="image-desc-3" name="resim_aciklama_3" placeholder="Resim açıklaması (opsiyonel)" class="w-full p-2 border border-gray-300 rounded-lg text-xs focus:border-park-green-500 focus:ring-1 focus:ring-park-green-500">
                            <div class="preview-container mt-3" id="preview-3"></div>
                        </div>
                    </div>
                </div>                
                <!-- Resim Ekleme Butonu -->
                <button type="button" id="add-image-btn" class="mt-3 w-full text-park-green-700 text-sm hover:text-park-green-900 transition-colors border border-park-green-300 rounded-lg py-2 px-3 bg-park-green-50 hover:bg-park-green-100">
                    <i class="fas fa-plus mr-1"></i>Resim Ekle
                </button>
            </div>
            
            <!-- Gönder Butonu -->
            <button type="submit" id="submit-problem-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm mobile-button">
                <i class="fas fa-paper-plane mr-1"></i>
                <span id="submit-text">Sorun Bildir</span>
                <div id="submit-loading" class="hidden inline-flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                    Gönderiliyor...
                </div>
            </button>
        </div>
    </div>
</div>

</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let map, userMarker, parkLayer, popup;
    let currentLocation = null;
    let currentPark = null;
    let imageCount = 1;    // Harita Başlatma
    function initMap() {
        // Popup overlay
        const popupContainer = document.createElement('div');
        popupContainer.className = 'ol-popup bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden max-w-xs';
        const popupContent = document.createElement('div');
        const popupCloser = document.createElement('a');
        popupCloser.href = '#';
        popupCloser.className = 'ol-popup-closer absolute top-2 right-2 w-6 h-6 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-gray-500 hover:text-gray-700 transition-colors';
        popupCloser.innerHTML = '<i class="fas fa-times text-xs"></i>';
        popupContainer.appendChild(popupCloser);
        popupContainer.appendChild(popupContent);

        popup = new ol.Overlay({
            element: popupContainer,
            autoPan: { animation: { duration: 250 } }
        });

        map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([37.0, 39.7]), // Sivas koordinatları
                zoom: 12
            }),
            controls: [],
            overlays: [popup]
        });

        // Park katmanı
        parkLayer = new ol.layer.Vector({
            source: new ol.source.Vector()
        });
        map.addLayer(parkLayer);

        // Harita tıklama olayı
        map.on('click', function(evt) {
            const feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                return feature;
            });            if (feature && feature.get('type') === 'park') {
                const park = feature.get('park');
                popupContent.innerHTML = `
                    <div class="p-4">
                        <!-- Header -->
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-park-green-500 to-green-600 rounded-full flex items-center justify-center shadow-md">
                                <i class="fas fa-tree text-white text-sm"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-park-green-800 text-sm leading-tight">${park.ad}</h3>
                                <span class="text-xs text-gray-500">${park.mahalle || 'Belirtilmemiş'}</span>
                            </div>
                        </div>
                        
                        <!-- Details -->
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 text-xs">
                                <div class="w-5 h-5 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-ruler-combined text-blue-600 text-xs"></i>
                                </div>
                                <div>
                                    <span class="text-gray-500">Alan:</span>
                                    <span class="font-medium text-gray-800">${park.alan ? park.alan.toLocaleString() + ' m²' : 'Belirtilmemiş'}</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2 text-xs">
                                <div class="w-5 h-5 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-tag text-purple-600 text-xs"></i>
                                </div>
                                <div>
                                    <span class="text-gray-500">Tip:</span>
                                    <span class="font-medium text-gray-800">${park.park_tipi || 'Belirtilmemiş'}</span>
                                </div>
                            </div>
                            
                            ${park.distance ? `
                            <div class="flex items-center gap-2 text-xs">
                                <div class="w-5 h-5 bg-orange-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-route text-orange-600 text-xs"></i>
                                </div>
                                <div>
                                    <span class="text-gray-500">Mesafe:</span>
                                    <span class="font-medium text-gray-800">${Math.round(park.distance)} metre</span>
                                </div>
                            </div>` : ''}
                        </div>
                        
                        <!-- Footer -->
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <div class="flex items-center justify-center gap-2 text-xs text-park-green-600">
                                <i class="fas fa-map-marker-alt"></i>
                                <span class="font-medium">Seçilen Park</span>
                            </div>
                        </div>
                    </div>
                `;
                popup.setPosition(evt.coordinate);
                popupCloser.onclick = function() {
                    popup.setPosition(undefined);
                    return false;
                };
            } else {
                popup.setPosition(undefined);
            }
        });
    }

    // Konum Bulma
    function findLocation() {
        if (!map) {
            showToast('Harita yüklenmedi, lütfen bekleyin.', 'warning');
            return;
        }
        
        showLoading();
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    hideLoading();
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Form gizli alanlarını doldur
                    document.getElementById('lat').value = currentLocation.lat;
                    document.getElementById('lng').value = currentLocation.lng;
                    
                    // Haritayı konuma odakla
                    const coords = ol.proj.fromLonLat([currentLocation.lng, currentLocation.lat]);
                    map.getView().setCenter(coords);
                    map.getView().setZoom(18);
                    
                    // Kullanıcı işaretçisi ekle
                    if (userMarker) {
                        parkLayer.getSource().removeFeature(userMarker);
                    }
                    
                    userMarker = new ol.Feature({
                        geometry: new ol.geom.Point(coords)
                    });
                    
                    userMarker.setStyle(new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 6,
                            fill: new ol.style.Fill({color: '#22c55e'}),
                            stroke: new ol.style.Stroke({color: '#ffffff', width: 1.5})
                        })
                    }));
                    
                    parkLayer.getSource().addFeature(userMarker);
                    
                    // Konum bilgisini göster
                    document.getElementById('location-info').classList.remove('hidden');
                    document.getElementById('coordinates').textContent = 
                        `Enlem: ${currentLocation.lat.toFixed(6)}, Boylam: ${currentLocation.lng.toFixed(6)}`;
                    document.getElementById('location-status').classList.remove('hidden');
                    
                    // Park arama
                    findNearbyPark();
                },
                function(error) {
                    hideLoading();
                    let errorMessage = 'Konum alınamadı';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Konum iznini verin';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Konum bilgisi kullanılamıyor';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Konum alma zaman aşımına uğradı';
                            break;
                    }
                    showToast(errorMessage, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        } else {
            hideLoading();
            showToast('Konum servisi desteklenmiyor.', 'error');
        }
    }

    // Yakındaki park arama
    function findNearbyPark() {
        if (!currentLocation) return;
        
        fetch('{% url "istakip:mobil_konum_park_bul" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(currentLocation)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentPark = data.park;
                document.getElementById('park-uuid').value = currentPark.uuid;
                showParkOnMap(data.park);
                showStatusSelection();
                // Mesafe bilgisini göster
                if (data.park.distance) {
                    document.getElementById('distance').textContent = 
                        `Parka mesafe: ${Math.round(data.park.distance)} metre`;
                }
            } else {
                showToast(data.message, 'warning');
            }
        })
        .catch(error => {
            showToast('Park arama hatası: ' + error.message, 'error');
        });
    }

    // Parkı haritada göster
    function showParkOnMap(park) {
        if (!currentLocation) return;
        
        try {
            let parkFeature = null;
            let parkExtent = null;
            
            // GeoJSON varsa kullan
            if (park.geojson) {
                try {
                    const geoJSON = JSON.parse(park.geojson);
                    const format = new ol.format.GeoJSON();
                    parkFeature = format.readFeature(geoJSON, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: 'EPSG:3857'
                    });
                    parkExtent = parkFeature.getGeometry().getExtent();
                } catch (geoJsonError) {
                    console.error('GeoJSON parse hatası:', geoJsonError);
                }
            }
            
            // GeoJSON yoksa bounds kullan
            if (!parkFeature && park.bounds) {
                const bounds = park.bounds;
                if (Array.isArray(bounds) && bounds.length === 4) {
                    parkExtent = ol.proj.transformExtent(bounds, 'EPSG:4326', 'EPSG:3857');
                    const parkCoords = [
                        [bounds[0], bounds[1]],
                        [bounds[2], bounds[1]],
                        [bounds[2], bounds[3]],
                        [bounds[0], bounds[3]],
                        [bounds[0], bounds[1]]
                    ];
                    const transformedCoords = parkCoords.map(coord => 
                        ol.proj.fromLonLat(coord)
                    );
                    parkFeature = new ol.Feature({
                        geometry: new ol.geom.Polygon([transformedCoords])
                    });
                }
            }
            
            // Fallback
            if (!parkFeature) {
                const userCoords = ol.proj.fromLonLat([currentLocation.lng, currentLocation.lat]);
                parkFeature = new ol.Feature({
                    geometry: new ol.geom.Circle(userCoords, 100)
                });
                parkExtent = [
                    userCoords[0] - 200, userCoords[1] - 200,
                    userCoords[0] + 200, userCoords[1] + 200
                ];
            }
            
            // Park özelliklerini ekle
            parkFeature.set('type', 'park');
            parkFeature.set('park', park);
            
            // Park stilini ayarla
            parkFeature.setStyle(new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(34, 197, 94, 0.2)'
                }),
                stroke: new ol.style.Stroke({
                    color: '#22c55e',
                    width: 2
                })
            }));
            
            // Kullanıcı konumundan parka çizgi
            const userCoords = ol.proj.fromLonLat([currentLocation.lng, currentLocation.lat]);
            const parkCenter = ol.extent.getCenter(parkExtent);
            
            const lineFeature = new ol.Feature({
                geometry: new ol.geom.LineString([userCoords, parkCenter])
            });
            
            lineFeature.setStyle(new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#3b82f6',
                    width: 2,
                    lineDash: [8, 4]
                })
            }));
            
            // Katmana ekle
            parkLayer.getSource().clear();
            parkLayer.getSource().addFeature(parkFeature);
            parkLayer.getSource().addFeature(lineFeature);
            parkLayer.getSource().addFeature(userMarker);
            
            // Haritayı park sınırlarına odakla
            map.getView().fit(parkExtent, {
                padding: [20, 20, 20, 20],
                duration: 1000,
                maxZoom: 19
            });

        } catch (error) {
            console.error('Park haritada gösterilirken hata:', error);
        }
    }

    // Durum seçimini göster
    function showStatusSelection() {
        document.getElementById('status-selection').classList.remove('hidden');
    }

    // Sorun yok butonuna tıklama
    function submitNoProblem() {
        if (!currentPark || !currentLocation) {
            showToast('Konum ve park bilgisi gerekli.', 'error');
            return;
        }
        
        // Loading göster
        const btn = document.getElementById('no-problem-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-park-green-600 mx-auto"></div>';
        btn.disabled = true;
        
        // Form alanlarını doldur ve gönder
        document.getElementById('park-uuid').value = currentPark.uuid;
        document.getElementById('lat').value = currentLocation.lat;
        document.getElementById('lng').value = currentLocation.lng;
        
        // Gizli durum alanı ekle
        const durumInput = document.createElement('input');
        durumInput.type = 'hidden';
        durumInput.name = 'durum';
        durumInput.value = 'sorun_yok';
        document.getElementById('main-form').appendChild(durumInput);
        
        // Formu gönder
        document.getElementById('main-form').submit();
    }

    // Sorun var butonuna tıklama
    function showProblemForm() {
        document.getElementById('problem-form').classList.remove('hidden');
        document.getElementById('problem-form').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }

    // Resim ekleme
    function addImageUpload() {
        if (imageCount >= 3) return;
        
        imageCount++;
        document.getElementById(`upload-card-${imageCount}`).classList.remove('hidden');
        
        if (imageCount >= 3) {
            document.getElementById('add-image-btn').style.display = 'none';
        }
    }    // Resim yükleme işlemi
    window.handleImageUpload = function(index) {
        const input = document.getElementById(`image-${index}`);
        const preview = document.getElementById(`preview-${index}`);
        const label = document.querySelector(`label[for="image-${index}"] .label-text`);
        const card = document.getElementById(`upload-card-${index}`);
        
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('Resim boyutu 5MB\'dan küçük olmalı.', 'error');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `
                    <div class="bg-white rounded-lg overflow-hidden shadow-soft border border-gray-200">
                        <div class="relative">
                            <img src="${e.target.result}" alt="Önizleme" class="image-preview w-full h-32 object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
                            <button type="button" class="remove-image absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs transition-colors shadow-lg" onclick="removeImage(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="absolute bottom-2 left-2 bg-black/50 text-white text-xs px-2 py-1 rounded">
                                ${(file.size / (1024 * 1024)).toFixed(1)} MB
                            </div>
                        </div>
                        <div class="p-2">
                            <div class="text-xs text-gray-600 font-medium truncate" title="${file.name}">
                                <i class="fas fa-image mr-1 text-park-green-600"></i>
                                ${file.name}
                            </div>
                        </div>
                    </div>
                `;
                
                // Card stilini güncelle
                card.classList.remove('border-dashed', 'border-gray-300');
                card.classList.add('border-solid', 'border-park-green-300', 'bg-park-green-50');
                
                // Sadece label metnini güncelle, input'u koru
                if (label) {
                    label.innerHTML = '<i class="fas fa-check mr-1"></i>Seçildi';
                    label.classList.remove('bg-gradient-to-r', 'from-park-green-600', 'to-park-green-700');
                    label.classList.add('bg-park-green-500');
                }
                
                // Sonraki resim kartını göster
                if (index < 3) {
                    const nextCard = document.getElementById(`upload-card-${index + 1}`);
                    if (nextCard && nextCard.classList.contains('hidden')) {
                        nextCard.classList.remove('hidden');
                        imageCount = index + 1;
                    }
                }
                
                if (imageCount >= 3) {
                    document.getElementById('add-image-btn').style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        }
    };    // Resim kaldırma
    window.removeImage = function(index) {
        const input = document.getElementById(`image-${index}`);
        const preview = document.getElementById(`preview-${index}`);
        const label = document.querySelector(`label[for="image-${index}"] .label-text`);
        const card = document.getElementById(`upload-card-${index}`);
        
        input.value = '';
        preview.innerHTML = '';
        
        // Card stilini sıfırla
        card.classList.remove('border-solid', 'border-park-green-300', 'bg-park-green-50');
        card.classList.add('border-dashed', 'border-gray-300', 'bg-gray-50');
        
        if (label) {
            label.innerHTML = `<i class="fas fa-camera mr-1"></i>${index}. Resim Seç`;
            label.classList.remove('bg-park-green-500');
            label.classList.add('bg-gradient-to-r', 'from-park-green-600', 'to-park-green-700');
        }
        
        // Sonraki kartları gizle ve imageCount'u güncelle
        for (let i = index + 1; i <= 3; i++) {
            const nextCard = document.getElementById(`upload-card-${i}`);
            const nextInput = document.getElementById(`image-${i}`);
            const nextPreview = document.getElementById(`preview-${i}`);
            const nextLabel = document.querySelector(`label[for="image-${i}"] .label-text`);
            
            if (nextInput && !nextInput.files[0]) {
                nextCard.classList.add('hidden');
                if (nextLabel) {
                    nextLabel.innerHTML = `<i class="fas fa-camera mr-1"></i>${i}. Resim Seç`;
                }
                nextPreview.innerHTML = '';
            }
        }
        
        // imageCount'u güncelle
        imageCount = 1;
        for (let i = 1; i <= 3; i++) {
            const checkInput = document.getElementById(`image-${i}`);
            if (checkInput && checkInput.files && checkInput.files[0]) {
                imageCount = i;
            }
        }
        
        // Add image butonunu göster
        document.getElementById('add-image-btn').style.display = 'block';
    };// Form submit işlemi
    function handleFormSubmit(e) {
        if (!currentPark || !currentLocation) {
            e.preventDefault();
            showToast('Konum ve park bilgisi gerekli.', 'error');
            return;
        }
        
        // Form validasyonu
        const problemForm = document.getElementById('problem-form');
        if (!problemForm.classList.contains('hidden')) {
            const aciklama = document.getElementById('problem-description').value.trim();
            if (!aciklama) {
                e.preventDefault();
                showToast('Açıklama alanı zorunludur.', 'error');
                return;
            }
        }
        
        // Loading göster
        const submitBtn = document.getElementById('submit-problem-btn');
        const submitText = document.getElementById('submit-text');
        const submitLoading = document.getElementById('submit-loading');
        
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
        submitBtn.disabled = true;
        
        // Form alanlarını doldur
        document.getElementById('park-uuid').value = currentPark.uuid;
        document.getElementById('lat').value = currentLocation.lat;
        document.getElementById('lng').value = currentLocation.lng;
        
        // Debug: Form verilerini konsola yazdır
        const formData = new FormData(document.getElementById('main-form'));
        console.log('Form verileri:');
        for (let [key, value] of formData.entries()) {
            if (value instanceof File) {
                console.log(key, ':', value.name, '-', value.size, 'bytes');
            } else {
                console.log(key, ':', value);
            }
        }
    }

    // Event Listeners
    document.getElementById('find-location-btn').addEventListener('click', findLocation);
    document.getElementById('refresh-btn').addEventListener('click', findLocation);
    document.getElementById('no-problem-btn').addEventListener('click', submitNoProblem);
    document.getElementById('problem-btn').addEventListener('click', showProblemForm);
    document.getElementById('add-image-btn').addEventListener('click', addImageUpload);
    document.getElementById('main-form').addEventListener('submit', handleFormSubmit);

    // Haritayı başlat
    setTimeout(function() {
        try {
            initMap();
        } catch (error) {
            console.error('Harita başlatılamadı:', error);
            showToast('Harita yüklenirken hata oluştu.', 'error');
        }
    }, 100);
});
</script>

<style>
.ol-popup {
    position: absolute;
    background-color: white;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    border-radius: 12px;
    min-width: 200px;
    max-width: 280px;
    border: 1px solid #e5e7eb;
    backdrop-filter: blur(10px);
    z-index: 1000;
}

.ol-popup::before {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid white;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}

.ol-popup-closer {
    text-decoration: none;
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: rgba(249, 250, 251, 0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    transition: all 0.2s ease;
    backdrop-filter: blur(4px);
    z-index: 10;
}

.ol-popup-closer:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
    transform: scale(1.1);
}

/* Animate pulse green */
@keyframes pulse-green {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.animate-pulse-green {
    animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* Mobile button improvements */
.mobile-button {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
}

.mobile-button:active {
    transform: scale(0.98);
}

/* Status selection button improvements */
#status-selection .group {
    position: relative;
    will-change: transform;
}

#status-selection .group::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 12px;
    padding: 2px;
    background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask-composite: xor;
    opacity: 0;
    transition: opacity 0.3s ease;
}

#status-selection .group:hover::after {
    opacity: 1;
}

/* Enhanced shadow for buttons */
.shadow-soft {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.group:hover .shadow-lg {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}
</style>
{% endblock %}