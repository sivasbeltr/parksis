{% extends 'istakip/mobil/layout_mobil.html' %}

{% block title %}Sorun Bildir - Saha Personeli{% endblock %}

{% block content %}
<!-- Harita Bölümü - Tam Genişlik -->
<div class="bg-white shadow-soft rounded-2xl mb-4 overflow-hidden">
    <div class="p-3">
        <div class="flex items-center justify-between">
            <h2 class="text-base font-bold text-gray-900 flex items-center">
                <i class="fas fa-map-marker-alt text-park-green-600 mr-1.5"></i>
                Konum Tespiti
            </h2>
            <div id="location-status" class="hidden flex items-center">
                <div class="w-2 h-2 bg-park-green-500 rounded-full animate-pulse-green mr-1"></div>
                <span class="text-xs text-gray-500">Konum Alınıyor</span>
            </div>
        </div>
    </div>
    
    <!-- Harita - Tam Genişlik -->
    <div id="map" class="map-container bg-gray-100"></div>
    
    <div class="p-3">
        <!-- Konum Butonları -->
        <div class="flex space-x-2">
            <button id="find-location-btn" class="flex-1 bg-park-green-600 hover:bg-park-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm mobile-button">
                <i class="fas fa-crosshairs mr-1"></i>
                Konumumu Bul
            </button>
            <button id="refresh-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-3 rounded-lg transition-colors text-sm mobile-button">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        
        <!-- Konum Bilgisi -->
        <div id="location-info" class="mt-2 p-2 bg-gray-50 rounded-lg hidden">
            <div class="text-xs text-gray-600">Konum:</div>
            <div id="coordinates" class="text-xs text-gray-500"></div>
            <div id="distance" class="text-xs text-gray-500"></div>
        </div>
    </div>
</div>

<div class="space-y-4 p-3">
    <!-- Durum Seçimi -->
    <div id="status-selection" class="bg-white rounded-2xl shadow-soft p-4 hidden">
        <h3 class="text-base font-bold text-gray-900 mb-3">Parkın Durumu</h3>
        <div class="grid grid-cols-2 gap-3">
            <button id="no-problem-btn" class="bg-park-green-100 hover:bg-park-green-200 text-park-green-800 font-medium py-3 px-4 rounded-lg border border-park-green-200 transition-all text-sm mobile-button">
                <i class="fas fa-check-circle text-lg mb-1 block"></i>
                Sorun Yok
            </button>
            <button id="problem-btn" class="bg-red-100 hover:bg-red-200 text-red-800 font-medium py-3 px-4 rounded-lg border border-red-200 transition-all text-sm mobile-button">
                <i class="fas fa-exclamation-triangle text-lg mb-1 block"></i>
                Sorun Var
            </button>
        </div>
    </div>
    
    <!-- Sorun Detay Formu -->
    <div id="problem-form" class="bg-white rounded-2xl shadow-soft p-4 hidden">
        <h3 class="text-base font-bold text-red-700 mb-3 flex items-center">
            <i class="fas fa-exclamation-triangle mr-1.5"></i>
            Sorun Detayları
        </h3>
        
        <form id="problem-submit-form" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            
            <!-- Sorun Türü -->
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Sorun Türü</label>
                <select id="problem-type" name="durum" class="w-full p-2 border border-gray-300 rounded-lg text-sm mobile-input focus:ring-1 focus:ring-red-500 focus:border-red-500">
                    <option value="sorun_var">Sorun Var</option>
                    <option value="acil">Acil Müdahale Gerekli</option>
                </select>
            </div>
            
            <!-- Açıklama -->
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Açıklama *</label>
                <textarea id="problem-description" name="aciklama" rows="3" class="w-full p-2 border border-gray-300 rounded-lg text-sm mobile-input resize-none focus:ring-1 focus:ring-red-500 focus:border-red-500" placeholder="Sorunun detaylarını yazın..." required></textarea>
            </div>
            
            <!-- Resim Yükleme -->
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-2">Resimler (Maks. 3)</label>
                <div class="space-y-2">
                    <!-- Resim 1 -->
                    <div class="image-upload-item" id="upload-card-1">
                        <div class="image-upload-container flex items-center gap-2">
                            <label for="image-1" class="file-input-wrapper cursor-pointer bg-park-green-600 hover:bg-park-green-700 text-white text-xs py-1.5 px-3 rounded-lg transition-colors">
                                <i class="fas fa-camera mr-1"></i>Resim
                                <input type="file" id="image-1" name="resim_1" accept="image/jpeg,image/png" class="hidden" onchange="handleImageUpload(1)">
                            </label>
                            <input type="text" id="image-desc-1" name="resim_aciklama_1" placeholder="Açıklama (opsiyonel)" class="flex-1 p-1.5 border border-gray-300 rounded-lg text-xs">
                        </div>
                        <div class="preview-container mt-2" id="preview-1"></div>
                    </div>
                    
                    <!-- Resim 2 -->
                    <div class="image-upload-item hidden" id="upload-card-2">
                        <div class="image-upload-container flex items-center gap-2">
                            <label for="image-2" class="file-input-wrapper cursor-pointer bg-park-green-600 hover:bg-park-green-700 text-white text-xs py-1.5 px-3 rounded-lg transition-colors">
                                <i class="fas fa-camera mr-1"></i>Resim
                                <input type="file" id="image-2" name="resim_2" accept="image/jpeg,image/png" class="hidden" onchange="handleImageUpload(2)">
                            </label>
                            <input type="text" id="image-desc-2" name="resim_aciklama_2" placeholder="Açıklama (opsiyonel)" class="flex-1 p-1.5 border border-gray-300 rounded-lg text-xs">
                        </div>
                        <div class="preview-container mt-2" id="preview-2"></div>
                    </div>
                    
                    <!-- Resim 3 -->
                    <div class="image-upload-item hidden" id="upload-card-3">
                        <div class="image-upload-container flex items-center gap-2">
                            <label for="image-3" class="file-input-wrapper cursor-pointer bg-park-green-600 hover:bg-park-green-700 text-white text-xs py-1.5 px-3 rounded-lg transition-colors">
                                <i class="fas fa-camera mr-1"></i>Resim
                                <input type="file" id="image-3" name="resim_3" accept="image/jpeg,image/png" class="hidden" onchange="handleImageUpload(3)">
                            </label>
                            <input type="text" id="image-desc-3" name="resim_aciklama_3" placeholder="Açıklama (opsiyonel)" class="flex-1 p-1.5 border border-gray-300 rounded-lg text-xs">
                        </div>
                        <div class="preview-container mt-2" id="preview-3"></div>
                    </div>
                </div>
                
                <!-- Resim Ekleme Butonu -->
                <button type="button" id="add-image-btn" class="mt-2 text-park-green-700 text-sm hover:text-park-green-900 transition-colors">
                    <i class="fas fa-plus mr-1"></i>Resim Ekle
                </button>
            </div>
            
            <!-- Gönder Butonu -->
            <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm mobile-button">
                <i class="fas fa-paper-plane mr-1"></i>
                Sorun Bildir
            </button>
        </form>
    </div>
    
    <!-- Başarı Mesajı -->
    <div id="success-message" class="bg-park-green-50 border border-park-green-200 rounded-2xl p-4 hidden">
        <div class="flex items-center">
            <div class="w-8 h-8 bg-park-green-500 rounded-full flex items-center justify-center mr-2">
                <i class="fas fa-check text-white text-sm"></i>
            </div>
            <div>
                <h3 class="text-base font-bold text-park-green-800">Başarılı!</h3>
                <p class="text-park-green-700 text-sm">Kontrol kaydınız oluşturuldu.</p>
            </div>
        </div>
        <button id="new-control-btn" class="mt-2 w-full bg-park-green-600 hover:bg-park-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm mobile-button">
            Yeni Kontrol
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let map, userMarker, parkLayer, popup;
    let currentLocation = null;
    let currentPark = null;
    let imageCount = 1;

    // Harita Başlatma
    function initMap() {
        // Popup overlay
        const popupContainer = document.createElement('div');
        popupContainer.className = 'ol-popup bg-white p-2 rounded-lg shadow-lg text-xs max-w-xs';
        const popupContent = document.createElement('div');
        const popupCloser = document.createElement('a');
        popupCloser.href = '#';
        popupCloser.className = 'ol-popup-closer absolute top-1 right-1 text-gray-500 hover:text-gray-700';
        popupCloser.innerHTML = '<i class="fas fa-times"></i>';
        popupContainer.appendChild(popupCloser);
        popupContainer.appendChild(popupContent);

        popup = new ol.Overlay({
            element: popupContainer,
            autoPan: { animation: { duration: 250 } }
        });

        map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([37.0, 39.7]), // Sivas koordinatları
                zoom: 12
            }),
            controls: [],
            overlays: [popup]
        });

        // Park katmanı
        parkLayer = new ol.layer.Vector({
            source: new ol.source.Vector()
        });
        map.addLayer(parkLayer);

        // Harita tıklama olayı
        map.on('click', function(evt) {
            const feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                return feature;
            });
            if (feature && feature.get('type') === 'park') {
                const park = feature.get('park');
                popupContent.innerHTML = `
                    <div class="font-bold text-park-green-800">${park.ad}</div>
                    <div class="text-gray-600">
                        <div><i class="fas fa-map-marker-alt mr-1"></i>${park.mahalle || 'Belirtilmemiş'}</div>
                        <div><i class="fas fa-ruler-combined mr-1"></i>${park.alan ? park.alan.toLocaleString() + ' m²' : 'Belirtilmemiş'}</div>
                        <div><i class="fas fa-tag mr-1"></i>${park.park_tipi || 'Belirtilmemiş'}</div>
                    </div>
                `;
                popup.setPosition(evt.coordinate);
                popupCloser.onclick = function() {
                    popup.setPosition(undefined);
                    return false;
                };
            } else {
                popup.setPosition(undefined);
            }
        });
    }

    // Konum Bulma
    function findLocation() {
        if (!map) {
            showToast('Harita yüklenmedi, lütfen bekleyin.', 'warning');
            return;
        }
        
        showLoading();
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    hideLoading();
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Haritayı konuma odakla
                    const coords = ol.proj.fromLonLat([currentLocation.lng, currentLocation.lat]);
                    map.getView().setCenter(coords);
                    map.getView().setZoom(18);
                    
                    // Kullanıcı işaretçisi ekle
                    if (userMarker) {
                        parkLayer.getSource().removeFeature(userMarker);
                    }
                    
                    userMarker = new ol.Feature({
                        geometry: new ol.geom.Point(coords)
                    });
                    
                    userMarker.setStyle(new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 6,
                            fill: new ol.style.Fill({color: '#22c55e'}),
                            stroke: new ol.style.Stroke({color: '#ffffff', width: 1.5})
                        })
                    }));
                    
                    parkLayer.getSource().addFeature(userMarker);
                    
                    // Konum bilgisini göster
                    document.getElementById('location-info').classList.remove('hidden');
                    document.getElementById('coordinates').textContent = 
                        `Enlem: ${currentLocation.lat.toFixed(6)}, Boylam: ${currentLocation.lng.toFixed(6)}`;
                    document.getElementById('location-status').classList.remove('hidden');
                    
                    // Park arama
                    findNearbyPark();
                },
                function(error) {
                    hideLoading();
                    let errorMessage = 'Konum alınamadı';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Konum iznini verin';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Konum bilgisi kullanılamıyor';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Konum alma zaman aşımına uğradı';
                            break;
                    }
                    showToast(errorMessage, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        } else {
            hideLoading();
            showToast('Konum servisi desteklenmiyor.', 'error');
        }
    }

    // Yakındaki park arama
    function findNearbyPark() {
        if (!currentLocation) return;
        
        fetch('{% url "istakip:mobil_konum_park_bul" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(currentLocation)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentPark = data.park;
                showParkOnMap(data.park);
                showStatusSelection();
                // Mesafe bilgisini göster
                if (data.park.distance) {
                    document.getElementById('distance').textContent = 
                        `Parka mesafe: ${Math.round(data.park.distance)} metre`;
                }
            } else {
                showToast(data.message, 'warning');
            }
        })
        .catch(error => {
            showToast('Park arama hatası: ' + error.message, 'error');
        });
    }

    // Parkı haritada göster ve odaklan
    function showParkOnMap(park) {
        if (!currentLocation) return;
        
        try {
            let parkFeature = null;
            let parkExtent = null;
            
            // GeoJSON varsa kullan
            if (park.geojson) {
                try {
                    const geoJSON = JSON.parse(park.geojson);
                    const format = new ol.format.GeoJSON();
                    parkFeature = format.readFeature(geoJSON, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: 'EPSG:3857'
                    });
                    parkExtent = parkFeature.getGeometry().getExtent();
                } catch (geoJsonError) {
                    console.error('GeoJSON parse hatası:', geoJsonError);
                }
            }
            
            // GeoJSON yoksa bounds kullan
            if (!parkFeature && park.bounds) {
                const bounds = park.bounds;
                if (Array.isArray(bounds) && bounds.length === 4) {
                    parkExtent = ol.proj.transformExtent(bounds, 'EPSG:4326', 'EPSG:3857');
                    const parkCoords = [
                        [bounds[0], bounds[1]],
                        [bounds[2], bounds[1]],
                        [bounds[2], bounds[3]],
                        [bounds[0], bounds[3]],
                        [bounds[0], bounds[1]]
                    ];
                    const transformedCoords = parkCoords.map(coord => 
                        ol.proj.fromLonLat(coord)
                    );
                    parkFeature = new ol.Feature({
                        geometry: new ol.geom.Polygon([transformedCoords])
                    });
                }
            }
            
            // Fallback
            if (!parkFeature) {
                const userCoords = ol.proj.fromLonLat([currentLocation.lng, currentLocation.lat]);
                parkFeature = new ol.Feature({
                    geometry: new ol.geom.Circle(userCoords, 100)
                });
                parkExtent = [
                    userCoords[0] - 200, userCoords[1] - 200,
                    userCoords[0] + 200, userCoords[1] + 200
                ];
            }
            
            // Park özelliklerini ekle
            parkFeature.set('type', 'park');
            parkFeature.set('park', park);
            
            // Park stilini ayarla
            parkFeature.setStyle(new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(34, 197, 94, 0.2)'
                }),
                stroke: new ol.style.Stroke({
                    color: '#22c55e',
                    width: 2
                })
            }));
            
            // Kullanıcı konumundan parka çizgi
            const userCoords = ol.proj.fromLonLat([currentLocation.lng, currentLocation.lat]);
            const parkCenter = ol.extent.getCenter(parkExtent);
            
            const lineFeature = new ol.Feature({
                geometry: new ol.geom.LineString([userCoords, parkCenter])
            });
            
            lineFeature.setStyle(new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#3b82f6',
                    width: 2,
                    lineDash: [8, 4]
                })
            }));
            
            // Katmana ekle
            parkLayer.getSource().clear();
            parkLayer.getSource().addFeature(parkFeature);
            parkLayer.getSource().addFeature(lineFeature);
            parkLayer.getSource().addFeature(userMarker);
            
            // Haritayı park sınırlarına odakla
            map.getView().fit(parkExtent, {
                padding: [20, 20, 20, 20],
                duration: 1000,
                maxZoom: 19
            });
            
            // Popup ile park bilgilerini göster
            popupContent.innerHTML = `
                <div class="font-bold text-park-green-800">${park.ad}</div>
                <div class="text-gray-600">
                    <div><i class="fas fa-map-marker-alt mr-1"></i>${park.mahalle || 'Belirtilmemiş'}</div>
                    <div><i class="fas fa-ruler-combined mr-1"></i>${park.alan ? park.alan.toLocaleString() + ' m²' : 'Belirtilmemiş'}</div>
                    <div><i class="fas fa-tag mr-1"></i>${park.park_tipi || 'Belirtilmemiş'}</div>
                </div>
            `;
            popup.setPosition(parkCenter);

        } catch (error) {
            console.error('Park haritada gösterilirken hata:', error);
            const userCoords = ol.proj.fromLonLat([currentLocation.lng, currentLocation.lat]);
            map.getView().animate({
                center: userCoords,
                zoom: 18,
                duration: 1000
            });
        }
    }

    // Durum seçimini göster
    function showStatusSelection() {
        document.getElementById('status-selection').classList.remove('hidden');
    }

    // Sorun yok işlemi
    function submitNoProblem() {
        if (!currentPark || !currentLocation) {
            showToast('Konum ve park bilgisi gerekli.', 'error');
            return;
        }
        
        showLoading();
        
        const formData = new FormData();
        formData.append('park_uuid', currentPark.uuid);
        formData.append('durum', 'sorun_yok');
        formData.append('lat', currentLocation.lat);
        formData.append('lng', currentLocation.lng);
        formData.append('csrfmiddlewaretoken', getCsrfToken());
        
        fetch('{% url "istakip:mobil_sorun_kaydet" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showSuccessMessage();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showToast('Kayıt hatası: ' + error.message, 'error');
        });
    }

    // Sorun var formu göster
    function showProblemForm() {
        document.getElementById('problem-form').classList.remove('hidden');
        document.getElementById('problem-form').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }

    // Resim ekleme
    function addImageUpload() {
        if (imageCount >= 3) return;
        
        imageCount++;
        document.getElementById(`upload-card-${imageCount}`).classList.remove('hidden');
        
        if (imageCount >= 3) {
            document.getElementById('add-image-btn').style.display = 'none';
        }
    }

    // Resim yükleme işlemi
    window.handleImageUpload = function(index) {
        const input = document.getElementById(`image-${index}`);
        const preview = document.getElementById(`preview-${index}`);
        
        if (input.files && input.files[0]) {
            const file = input.files[0];
            console.log(`Resim ${index} seçildi:`, {
                name: file.name,
                size: file.size,
                type: file.type
            });
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('Resim boyutu 5MB\'dan küçük olmalı.', 'error');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `
                    <div class="relative inline-block">
                        <img src="${e.target.result}" alt="Önizleme" class="image-preview w-16 h-16 object-cover rounded-lg border border-gray-300">
                        <button type="button" class="remove-image absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs" onclick="removeImage(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
            
            const wrapper = input.closest('.image-upload-container').querySelector('.file-input-wrapper');
            wrapper.innerHTML = `<i class="fas fa-check mr-1"></i>Seçildi`;
            wrapper.classList.remove('bg-park-green-600', 'hover:bg-park-green-700');
            wrapper.classList.add('bg-park-green-500');
        } else {
            console.log(`Resim ${index} seçilemedi:`, input.files);
            showToast(`Resim ${index} seçilemedi.`, 'error');
        }
    };

    // Resim kaldırma
    window.removeImage = function(index) {
        const input = document.getElementById(`image-${index}`);
        const preview = document.getElementById(`preview-${index}`);
        const wrapper = input.closest('.image-upload-container').querySelector('.file-input-wrapper');
        
        input.value = '';
        preview.innerHTML = '';
        wrapper.innerHTML = `<i class="fas fa-camera mr-1"></i>Resim`;
        wrapper.classList.remove('bg-park-green-500');
        wrapper.classList.add('bg-park-green-600', 'hover:bg-park-green-700');
        console.log(`Resim ${index} kaldırıldı`);
    };

    // Sorun bildirimi gönder
    function submitProblem() {
        if (!currentPark || !currentLocation) {
            showToast('Konum ve park bilgisi gerekli.', 'error');
            return;
        }
        
        const form = document.getElementById('problem-submit-form');
        const formData = new FormData();
        
        // Formdaki metin alanlarını ekle
        formData.append('durum', document.getElementById('problem-type').value);
        formData.append('aciklama', document.getElementById('problem-description').value);
        formData.append('csrfmiddlewaretoken', getCsrfToken());
        formData.append('park_uuid', currentPark.uuid);
        formData.append('lat', currentLocation.lat);
        formData.append('lng', currentLocation.lng);
        
        // Resim dosyalarını ve açıklamalarını manuel olarak ekle
        for (let i = 1; i <= 3; i++) {
            const input = document.getElementById(`image-${i}`);
            const desc = document.getElementById(`image-desc-${i}`).value;
            if (input.files && input.files[0]) {
                formData.append(`resim_${i}`, input.files[0]);
                if (desc) {
                    formData.append(`resim_aciklama_${i}`, desc);
                }
                console.log(`Resim ${i} eklendi:`, input.files[0].name);
            } else {
                console.log(`Resim ${i} bulunamadı`);
            }
        }
        
        // FormData içeriğini kontrol et
        for (let pair of formData.entries()) {
            console.log(`FormData: ${pair[0]} =`, pair[1]);
        }
        
        showLoading();
        
        fetch('{% url "istakip:mobil_sorun_kaydet" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('Sunucu yanıtı:', response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            hideLoading();
            console.log('Sunucu veri:', data);
            if (data.success) {
                showSuccessMessage();
            } else {
                showToast(data.message || 'Kayıt başarısız.', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Hata:', error);
            showToast('Kayıt hatası: ' + error.message, 'error');
        });
    }

    // Başarı mesajını göster
    function showSuccessMessage() {
        document.getElementById('status-selection').classList.add('hidden');
        document.getElementById('problem-form').classList.add('hidden');
        document.getElementById('success-message').classList.remove('hidden');
    }

    // Yeni kontrol
    function resetForm() {
        document.getElementById('status-selection').classList.add('hidden');
        document.getElementById('problem-form').classList.add('hidden');
        document.getElementById('success-message').classList.add('hidden');
        document.getElementById('location-info').classList.add('hidden');
        document.getElementById('location-status').classList.add('hidden');
        
        document.getElementById('problem-submit-form').reset();
        
        imageCount = 1;
        for (let i = 2; i <= 3; i++) {
            const uploadCard = document.getElementById(`upload-card-${i}`);
            if (uploadCard) uploadCard.classList.add('hidden');
            uploadCard.classList.add('hidden');
        }
        
        for (let i = 1; i <= 3; i++) {
            const preview = document.getElementById(`preview-${i}`);
            const input = document.getElementById(`image-${i}`);
            const wrapper = input.closest('.image-upload-container').querySelector('.file-input-wrapper');
            if (preview) {
                preview.innerHTML = '';
            }
            if (input) {
                input.value = '';
            }
            if (wrapper) {
                wrapper.innerHTML = `<i class="fas fa-camera mr-1"></i>Resim`;
                wrapper.classList.remove('bg-park-green-500');
                wrapper.classList.add('bg-park-green-600', 'hover:bg-park-green-700');
            }
        }
        
        document.getElementById('add-image-btn').style.display = 'block';
        
        if (parkLayer) {
            parkLayer.getSource().clear();
        }
        
        map.getView().animate({
            center: ol.proj.fromLonLat([37.0, 39.7]),
            zoom: 12,
            duration: 500
        });
        
        currentLocation = null;
        currentPark = null;
        userMarker = null;
        popup.setPosition(undefined);
    }

    // Event Listeners
    document.getElementById('find-location-btn').addEventListener('click', findLocation);
    document.getElementById('refresh-btn').addEventListener('click', findLocation);
    document.getElementById('no-problem-btn').addEventListener('click', submitNoProblem);
    document.getElementById('problem-btn').addEventListener('click', showProblemForm);
    document.getElementById('add-image-btn').addEventListener('click', addImageUpload);
    document.getElementById('problem-submit-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitProblem();
    });
    document.getElementById('new-control-btn').addEventListener('click', resetForm);

    // Haritayı başlat
    setTimeout(function() {
        try {
            initMap();
        } catch (error) {
            console.error('Harita başlatılamadı:', error);
            showToast('Harita yüklenirken hata oluştu.', 'error');
        }
    }, 100);
});
</script>

<style>
.ol-popup {
    position: absolute;
    background-color: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border-radius: 8px;
    padding: 8px;
    min-width: 150px;
    max-width: 200px;
}
.ol-popup-closer {
    text-decoration: none;
    position: absolute;
    top: 4px;
    right: 4px;
}
</style>
{% endblock %}