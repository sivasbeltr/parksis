{% extends 'layout.html' %}
{% load static %}

{% block title %}{{ kontrol.park.ad }} - Sorun Detayı{% endblock %}

{% block page_title %}
<div class="flex items-center justify-between">
    <div class="flex items-center gap-3">
        <a href="{% url 'istakip:sorun_bildirimleri' %}" 
           class="text-gray-600 hover:text-gray-900 transition-colors">
            <i class="fas fa-arrow-left text-lg"></i>
        </a>
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                <i class="fas fa-exclamation-triangle text-amber-500 mr-2"></i>
                Sorun Detayı
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
                <i class="fas fa-map-marker-alt mr-1"></i>
                {{ kontrol.park.ad }} - {{ kontrol.kontrol_tarihi|date:"d.m.Y H:i" }}
            </p>
        </div>
    </div>
    
    <div class="flex items-center gap-3">
        <!-- Durum Etiketi -->
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
            {% if kontrol.durum == 'acil' %}
                bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300
            {% elif kontrol.durum == 'sorun_var' %}
                bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300
            {% elif kontrol.durum == 'ise_donusturuldu' %}
                bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300
            {% elif kontrol.durum == 'cozuldu' %}
                bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300
            {% else %}
                bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300
            {% endif %}">
            {% if kontrol.durum == 'acil' %}
                <i class="fas fa-exclamation-triangle mr-2"></i>ACİL
            {% elif kontrol.durum == 'sorun_var' %}
                <i class="fas fa-exclamation-circle mr-2"></i>SORUN VAR
            {% elif kontrol.durum == 'ise_donusturuldu' %}
                <i class="fas fa-arrow-right mr-2"></i>İŞE DÖNÜŞTÜRÜLDİ
            {% elif kontrol.durum == 'cozuldu' %}
                <i class="fas fa-check-circle mr-2"></i>ÇÖZÜLDÜ
            {% endif %}
        </span>
        
        <!-- Aksiyonlar -->
        {% if kontrol.durum in 'sorun_var,acil' and not kontrol.ilgili_gorevler.exists %}
            <a href="{% url 'istakip:sorun_gorev_donustur' kontrol.uuid %}"
               class="px-4 py-2 bg-park-green-600 hover:bg-park-green-700 text-white rounded-lg transition-colors">
                <i class="fas fa-plus-circle mr-2"></i>
                Göreve Dönüştür
            </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Ana Bilgiler Kartı -->
    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg rounded-xl border border-gray-200/60 dark:border-gray-700/60 overflow-hidden shadow-soft">
        <div class="px-6 py-4 bg-gradient-to-r from-park-green-50 to-emerald-50 dark:from-gray-700 dark:to-gray-800 border-b border-gray-200/60 dark:border-gray-700/60">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-park-green-100 dark:bg-park-green-900/30 rounded-xl flex items-center justify-center">
                    <i class="fas fa-info-circle text-park-green-600 dark:text-park-green-400 text-xl"></i>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Bildirim Bilgileri</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Sorun bildirimi detay bilgileri</p>
                </div>
            </div>
        </div>
        
        <div class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Sol Kolon -->
                <div class="space-y-6">
                    <!-- Park Bilgileri -->
                    <div class="space-y-3">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Park Bilgileri</h3>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-park-green-600 w-4"></i>
                                <span class="font-medium text-gray-900 dark:text-white">{{ kontrol.park.ad }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-building text-gray-500 w-4"></i>
                                <span class="text-gray-600 dark:text-gray-400">{{ kontrol.park.mahalle.ad }}, {{ kontrol.park.mahalle.ilce.ad }}</span>
                            </div>
                            {% if kontrol.park.park_tipi %}
                            <div class="flex items-center gap-2">
                                <i class="fas fa-tag text-gray-500 w-4"></i>
                                <span class="text-gray-600 dark:text-gray-400">{{ kontrol.park.park_tipi.ad }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Personel Bilgileri -->
                    <div class="space-y-3">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Bildiren Personel</h3>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-user text-blue-600 w-4"></i>
                                <span class="font-medium text-gray-900 dark:text-white">{{ kontrol.personel.ad }}</span>
                            </div>
                            {% if kontrol.personel.telefon %}
                            <div class="flex items-center gap-2">
                                <i class="fas fa-phone text-gray-500 w-4"></i>
                                <a href="tel:{{ kontrol.personel.telefon }}" class="text-blue-600 hover:text-blue-800">{{ kontrol.personel.telefon }}</a>
                            </div>
                            {% endif %}
                            {% if kontrol.personel.pozisyon %}
                            <div class="flex items-center gap-2">
                                <i class="fas fa-briefcase text-gray-500 w-4"></i>
                                <span class="text-gray-600 dark:text-gray-400">{{ kontrol.personel.pozisyon }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Sağ Kolon -->
                <div class="space-y-6">
                    <!-- Tarih Bilgileri -->
                    <div class="space-y-3">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Zaman Bilgileri</h3>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-calendar-alt text-amber-600 w-4"></i>
                                <span class="font-medium text-gray-900 dark:text-white">{{ kontrol.kontrol_tarihi|date:"d.m.Y" }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-clock text-gray-500 w-4"></i>
                                <span class="text-gray-600 dark:text-gray-400">{{ kontrol.kontrol_tarihi|date:"H:i" }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-history text-gray-500 w-4"></i>
                                <span class="text-gray-600 dark:text-gray-400">{{ kontrol.kontrol_tarihi|timesince }} önce</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sorun Açıklaması -->
                    {% if kontrol.aciklama %}
                    <div class="space-y-3">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Sorun Açıklaması</h3>
                        <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                            <p class="text-gray-800 dark:text-gray-200 leading-relaxed">{{ kontrol.aciklama }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resimler -->
    {% if kontrol.resimler.exists %}
    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg rounded-xl border border-gray-200/60 dark:border-gray-700/60 overflow-hidden shadow-soft">
        <div class="px-6 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-700 dark:to-gray-800 border-b border-gray-200/60 dark:border-gray-700/60">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center">
                    <i class="fas fa-camera text-blue-600 dark:text-blue-400 text-xl"></i>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Sorun Resimleri</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ kontrol.resimler.count }} resim</p>
                </div>
            </div>
        </div>
        
        <div class="p-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for resim in kontrol.resimler.all %}
                <div class="group relative overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-all duration-200">
                    <div class="aspect-w-16 aspect-h-9">
                        <img src="{{ resim.resim.url }}" 
                             alt="Sorun resmi" 
                             class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-200">
                    </div>
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center">
                        <a href="{{ resim.resim.url }}" target="_blank"
                           class="opacity-0 group-hover:opacity-100 bg-white text-gray-800 px-3 py-1 rounded-full text-sm font-medium transition-opacity duration-200">
                            <i class="fas fa-expand mr-1"></i>
                            Büyüt
                        </a>
                    </div>
                    {% if resim.aciklama %}
                    <div class="p-3 bg-gray-50 dark:bg-gray-700">
                        <p class="text-sm text-gray-600 dark:text-gray-400">{{ resim.aciklama }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- İlgili Görevler -->
    {% if ilgili_gorevler %}
    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg rounded-xl border border-gray-200/60 dark:border-gray-700/60 overflow-hidden shadow-soft">
        <div class="px-6 py-4 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-gray-700 dark:to-gray-800 border-b border-gray-200/60 dark:border-gray-700/60">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-xl flex items-center justify-center">
                    <i class="fas fa-tasks text-green-600 dark:text-green-400 text-xl"></i>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">İlgili Görevler</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Bu sorundan oluşturulan görevler</p>
                </div>
            </div>
        </div>
        
        <div class="p-6">
            <div class="space-y-4">
                {% for gorev in ilgili_gorevler %}
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h4 class="font-medium text-gray-900 dark:text-white">{{ gorev.baslik }}</h4>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                    {% if gorev.durum == 'tamamlandi' %}
                                        bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300
                                    {% elif gorev.durum == 'devam_ediyor' %}
                                        bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300
                                    {% elif gorev.durum == 'planlanmis' %}
                                        bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300
                                    {% else %}
                                        bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300
                                    {% endif %}">
                                    {{ gorev.get_durum_display }}
                                </span>
                            </div>
                            
                            {% if gorev.aciklama %}
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">{{ gorev.aciklama|truncatewords:15 }}</p>
                            {% endif %}
                            
                            <div class="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400">
                                <span><i class="fas fa-calendar mr-1"></i>{{ gorev.baslangic_tarihi|date:"d.m.Y" }}</span>
                                {% if gorev.atamalar.exists %}
                                <span><i class="fas fa-user mr-1"></i>{{ gorev.atamalar.count }} personel</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <a href="{% url 'istakip:gorev_detail' gorev.uuid %}"
                               class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-eye mr-1"></i>
                                Görevi Görüntüle
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- İlgili Bilgiler (Sidebar) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Aynı Parktaki Diğer Sorunlar -->
        {% if ayni_parkta_sorunlar %}
        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg rounded-xl border border-gray-200/60 dark:border-gray-700/60 overflow-hidden shadow-soft">
            <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200/60 dark:border-gray-700/60">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-map-marker-alt text-park-green-600 mr-2"></i>
                    Aynı Parktaki Diğer Sorunlar
                </h3>
            </div>
            
            <div class="p-6">
                <div class="space-y-3">
                    {% for sorun in ayni_parkta_sorunlar %}
                    <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-700 last:border-0">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">{{ sorun.kontrol_tarihi|date:"d.m.Y" }}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ sorun.get_durum_display }} • {{ sorun.personel.ad }}</p>
                        </div>
                        <a href="{% url 'istakip:sorun_detay' sorun.uuid %}"
                           class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Personelin Son Bildirimleri -->
        {% if personel_son_bildirimleri %}
        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg rounded-xl border border-gray-200/60 dark:border-gray-700/60 overflow-hidden shadow-soft">
            <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200/60 dark:border-gray-700/60">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-user text-blue-600 mr-2"></i>
                    {{ kontrol.personel.ad }}'in Son Bildirimleri
                </h3>
            </div>
            
            <div class="p-6">
                <div class="space-y-3">
                    {% for bildirim in personel_son_bildirimleri %}
                    <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-700 last:border-0">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">{{ bildirim.park.ad }}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ bildirim.kontrol_tarihi|date:"d.m.Y" }} • {{ bildirim.get_durum_display }}</p>
                        </div>
                        <a href="{% url 'istakip:sorun_detay' bildirim.uuid %}"
                           class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}